<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Delirium CAM Assessment</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, select, button { margin: 5px 0; padding: 8px; width: 100%; }
    .section { margin-bottom: 20px; }
  </style>
</head>
<body>

  <h2>üîç Search Patient</h2>
  <div class="section">
    <input type="text" id="hn" placeholder="Enter HN">
    <button onclick="searchPatient()">Search</button>
  </div>

  <div id="patientInfo" class="section" style="display: none;">
    <h3>üßë‚Äç‚öïÔ∏è Patient Info</h3>
    <p><b>Name:</b> <span id="name"></span></p>
    <p><b>Sex:</b> <span id="sex"></span></p>
    <p><b>Age:</b> <span id="age"></span></p>
    <p><b>Dx:</b> <span id="dx"></span></p>
    <p><b>Admit Date:</b> <span id="admit"></span></p>
    <p><b>Patient Day:</b> <span id="patientDay"></span></p>
  </div>

  <div id="camSection" class="section" style="display: none;">
    <h3>üìù Record CAM</h3>
    <input type="text" id="bed" placeholder="Bed">
    <select id="shift">
      <option value="Morning">Morning</option>
      <option value="Evening">Evening</option>
      <option value="Night">Night</option>
    </select>
    <select id="rass">
      <option value="-5">-5</option>
      <option value="-4">-4</option>
      <option value="-3">-3</option>
      <option value="-2">-2</option>
      <option value="-1">-1</option>
      <option value="0" selected>0</option>
      <option value="1">+1</option>
      <option value="2">+2</option>
      <option value="3">+3</option>
      <option value="4">+4</option>
    </select>
    <select id="cam1"><option value="0">Inattentive</option><option value="1" selected>Attentive</option></select>
    <select id="cam2"><option value="0">Disorganized</option><option value="1" selected>Organized</option></select>
    <select id="cam3"><option value="0">Altered</option><option value="1" selected>No Alteration</option></select>
    <select id="cam4"><option value="0">Fluctuating</option><option value="1" selected>No Fluctuation</option></select>
    <button onclick="submitCAM()">Submit CAM</button>
  </div>

  <div id="historySection" class="section" style="display: none;">
    <h3>üìú CAM History</h3>
    <table border="1" width="100%" id="camTable">
      <thead>
        <tr>
          <th>Date</th><th>Shift</th><th>Bed</th><th>RASS</th>
          <th>CAM1</th><th>CAM2</th><th>CAM3</th><th>CAM4</th><th>Result</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // ‡πÅ‡∏Å‡πâ URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Web App ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î Anyone ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    const SCRIPT = 'https://script.google.com/macros/s/AKfycbzpet80kK6CghYA-w3jF2iaIceWV5blQHFO6UYKEl9aaxCOdH4nJf44ZZL00Pryd1XCPw/exec';

    let currentHN = '';

    function searchPatient() {
      const hn = document.getElementById('hn').value.trim();
      if (!hn) return alert('Please enter HN');
      currentHN = hn;

      fetch(`${SCRIPT}?action=getPatient&hn=${hn}`)
        .then(res => {
          if (!res.ok) throw new Error('Request failed');
          return res.json();
        })
        .then(data => {
          if (!data || !data.HN) return alert('Patient not found');

          document.getElementById('name').textContent = data.Name;
          document.getElementById('sex').textContent = data.Sex;
          document.getElementById('age').textContent = data.Age;
          document.getElementById('dx').textContent = data.Dx;
          document.getElementById('admit').textContent = data.Admit;
          document.getElementById('patientDay').textContent = data.PatientDay;

          document.getElementById('patientInfo').style.display = 'block';
          document.getElementById('camSection').style.display = 'block';
          document.getElementById('historySection').style.display = 'block';

          loadCAMHistory(hn);
        })
        .catch(err => {
          console.error('Error:', err);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢');
        });
    }

    function submitCAM() {
      const bed = document.getElementById('bed').value;
      const shift = document.getElementById('shift').value;
      const rass = document.getElementById('rass').value;
      const cam1 = document.getElementById('cam1').value;
      const cam2 = document.getElementById('cam2').value;
      const cam3 = document.getElementById('cam3').value;
      const cam4 = document.getElementById('cam4').value;

      const today = new Date().toISOString().slice(0, 10);
      const result = (rass < -3) ? 'Unable to assess' :
        (cam1 == 0 && cam2 == 0 && (cam3 == 0 || cam4 == 0)) ? 'Delirium' : 'Negative';

      const payload = {
        type: 'cam',
        HN: currentHN,
        Date: today,
        Shift: shift,
        Bed: bed,
        RASS: rass,
        CAM1: cam1,
        CAM2: cam2,
        CAM3: cam3,
        CAM4: cam4,
        Result: result
      };

      fetch(SCRIPT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(res => {
          if (!res.ok) throw new Error('Submit failed');
          alert('CAM Submitted!');
          loadCAMHistory(currentHN);
        })
        .catch(err => {
          console.error('Submit error:', err);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
        });
    }

    function loadCAMHistory(hn) {
      fetch(`${SCRIPT}?action=getCAM&hn=${hn}`)
        .then(res => {
          if (!res.ok) throw new Error('Fetch CAM history failed');
          return res.json();
        })
        .then(data => {
          const tbody = document.getElementById('camTable').querySelector('tbody');
          tbody.innerHTML = '';
          data.reverse().forEach(entry => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${entry.Date}</td>
              <td>${entry.Shift}</td>
              <td>${entry.Bed}</td>
              <td>${entry.RASS}</td>
              <td>${entry.CAM1}</td>
              <td>${entry.CAM2}</td>
              <td>${entry.CAM3}</td>
              <td>${entry.CAM4}</td>
              <td><b>${entry.Result}</b></td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(err => {
          console.error('Load CAM history error:', err);
          alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ CAM');
        });
    }
  </script>
</body>
</html>
